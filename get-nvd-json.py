#!/usr/bin/env python

import requests
import os
import sys
import json
from tqdm import tqdm

def main():

    nvd_url = "https://services.nvd.nist.gov/rest/json/cves/1.0"
    payload = {
        "startIndex": 0,
        "resultsPerPage": 2000
    }

    if "NVD_API_KEY" in os.environ:
        payload['apiKey'] = os.environ['NVD_API_KEY']

    # Get page 1
    req = requests.get(nvd_url, params=payload)
    if req.status_code != 200:
        print(req)
        sys.exit(1)
    response = req.json()
    results = response["result"]
    total = response["totalResults"]

    payload["startIndex"] = payload["startIndex"] + response["resultsPerPage"]

    progress_bar = tqdm(total=total)
    progress_bar.update(response["resultsPerPage"])

    # Loop over pages
    while response["resultsPerPage"] > 0:
        req = requests.get(nvd_url, params=payload)
        if req.status_code != 200:
            print(req)
            sys.exit(1)
        response = req.json()
        payload["startIndex"] = payload["startIndex"] + response["resultsPerPage"]
        results["CVE_Items"].extend(response["result"]["CVE_Items"])

        progress_bar.update(response["resultsPerPage"])

    progress_bar.close()

    json_out = json.dumps(results, indent=2)
    with open("nvd-out.json", "w") as fh:
      fh.write(json_out)

if __name__ == "__main__":
    main()
